on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate version.lua
        run: |
          cat > version2.lua << 'EOF'
          return {
              run_number = ${{ github.run_number }},
              version = "1.0.${{ github.run_number }}",
              commitId = "${{ github.sha }}"
          }
          EOF

      - name: Commit version.lua
        run: |
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add version.lua
          git commit -m "ci: update version.lua [skip ci]"
          git push

      # 1️ Create a file to upload
      - name: Create artifact
        run: |
          mkdir dist
          echo "Build from commit $GITHUB_SHA" > dist/info.txt
          zip -r dist/package.zip dist

      # 2️ Create release + upload asset
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }}
          files: |
            dist/package.zip
